name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Clear TypeScript build cache
        run: |
          rm -rf node_modules/.cache
          rm -rf .tsbuildinfo

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run typecheck

      - name: Lint
        run: bun run lint

      - name: Build
        run: bun run build

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests with coverage
        run: |
          set -o pipefail
          bun test --coverage --coverage-reporter=lcov --coverage-reporter=text 2>&1 | tee coverage-output.txt

      - name: Check coverage threshold
        run: |
          # Extract coverage percentage from bun test output
          COVERAGE=$(grep -E "^All files" coverage-output.txt | awk '{print $4}' | tr -d '%' || true)
          if [ -z "$COVERAGE" ]; then
            # Try alternative parsing
            COVERAGE=$(grep -E "[0-9]+\.[0-9]+%" coverage-output.txt | tail -1 | grep -oE "[0-9]+\.[0-9]+" | head -1 || true)
          fi
          # Normalize: strip whitespace/% and default to 0 if empty
          COVERAGE=$(echo "$COVERAGE" | tr -d '% \t\n')
          [ -z "$COVERAGE" ] && COVERAGE="0"
          echo "Coverage: $COVERAGE%"
          # Check if coverage is below 40%
          if [ "$(echo "$COVERAGE < 40" | bc -l)" -eq 1 ]; then
            echo "❌ Coverage $COVERAGE% is below 40% threshold"
            exit 1
          fi
          echo "✅ Coverage $COVERAGE% meets 40% threshold"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Determine which paths changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      website: ${{ steps.filter.outputs.website }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            website:
              - 'website/**'

  website:
    needs: changes
    if: ${{ needs.changes.outputs.website == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Clear TypeScript build cache
        run: |
          cd website
          rm -rf node_modules/.cache
          rm -rf .tsbuildinfo

      - name: Install website dependencies
        run: cd website && bun install

      - name: Type check website
        run: cd website && bun run typecheck

      - name: Lint website
        run: cd website && bun run lint

      - name: Build website
        run: cd website && bun run build
